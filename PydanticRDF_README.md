# PydanticRDFDumper and PydanticRDFLoader

New RDF dumper and loader that work directly with Pydantic models using embedded LinkML metadata, eliminating the need for a separate SchemaView.

## Overview

These tools extract all necessary schema information from the `linkml_meta` attributes embedded in Pydantic models generated by LinkML, providing a fully self-contained RDF conversion solution.

## Key Features

### ✅ Schema-Free Operation
- No SchemaView dependency required
- Uses embedded `linkml_meta` from Pydantic models
- Fully self-contained conversion

### ✅ Semantic RDF Generation
- Proper class URIs from `class_uri` metadata (e.g., `schema:Person`)
- Correct property URIs from `slot_uri` and `exact_mappings`
- XSD datatypes for primitives (dates, booleans, numbers)
- Nested objects as properly typed blank nodes

### ✅ Round-Trip Fidelity
- Complete data preservation through RDF conversion
- Maintains complex nested structures
- Preserves all primitive types with correct datatypes

### ✅ CURIE/URI Handling
- Automatic prefix extraction from embedded metadata
- CURIE expansion and contraction
- Support for custom prefix mappings

## Usage

### Basic Dumping

```python
from linkml_runtime.dumpers.pydantic_rdf_dumper import PydanticRDFDumper
from your_models import Person, EmploymentEvent

# Create Pydantic model instances
person = Person(id="P:001", name="Alice Smith")

# Dump to RDF using embedded metadata
dumper = PydanticRDFDumper()
rdf_string = dumper.dumps(person)
```

### Basic Loading

```python
from linkml_runtime.loaders.pydantic_rdf_loader import PydanticRDFLoader
from your_models import Person

# Load RDF into Pydantic model
loader = PydanticRDFLoader()
person = loader.loads(rdf_string, Person)
```

### Round-Trip Example

```python
from datetime import date
from linkml_runtime.dumpers.pydantic_rdf_dumper import PydanticRDFDumper
from linkml_runtime.loaders.pydantic_rdf_loader import PydanticRDFLoader
from your_models import Person, EmploymentEvent

# Create complex nested data
employment = EmploymentEvent(
    employed_at="ROR:001",
    started_at_time=date(2020, 1, 1),
    is_current=True
)
person = Person(
    id="P:001", 
    name="Alice Smith",
    has_employment_history=[employment]
)

# Round-trip conversion
dumper = PydanticRDFDumper()
loader = PydanticRDFLoader()

rdf_output = dumper.dumps(person)
loaded_person = loader.loads(rdf_output, Person)

# Data is preserved
assert loaded_person.id == person.id
assert loaded_person.name == person.name
assert len(loaded_person.has_employment_history) == 1
```

## Generated RDF Example

Input Pydantic model:
```python
Person(
    id="P:001",
    name="Alice Smith", 
    primary_email="alice@example.org",
    has_employment_history=[
        EmploymentEvent(employed_at="ROR:001", started_at_time=date(2020, 1, 1))
    ]
)
```

Generated RDF:
```turtle
@prefix P: <http://example.org/P/> .
@prefix personinfo: <https://w3id.org/linkml/examples/personinfo/> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix schema1: <http://schema.org/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

P:001 a schema1:Person ;
    schema1:email "alice@example.org" ;
    schema1:name "Alice Smith" ;
    personinfo:has_employment_history [
        a personinfo:EmploymentEvent ;
        prov:startedAtTime "2020-01-01"^^xsd:date ;
        personinfo:employed_at "ROR:001"
    ] .
```

## How It Works

### Metadata Extraction

The dumper and loader extract schema information from two sources:

1. **Class-level metadata** (`linkml_meta` class variable):
```python
class Person(BaseModel):
    linkml_meta: ClassVar[LinkMLMeta] = LinkMLMeta({
        "class_uri": "schema:Person",
        "name": "Person",
        "from_schema": "https://w3id.org/linkml/examples/personinfo"
    })
```

2. **Field-level metadata** (`json_schema_extra` in Field definitions):
```python
name: str = Field(
    json_schema_extra={
        "linkml_meta": {
            "slot_uri": "schema:name",
            "from_schema": "https://w3id.org/linkml/examples/personinfo"
        }
    }
)
```

3. **Global metadata** (module-level `linkml_meta` with prefixes):
```python
linkml_meta = LinkMLMeta({
    "prefixes": {
        "schema": {"prefix_reference": "http://schema.org/"},
        "P": {"prefix_reference": "http://example.org/P/"}
    }
})
```

### Conversion Process

#### Dumping (Pydantic → RDF):
1. Extract global prefixes from module metadata
2. Create RDF graph with namespace bindings
3. For each object:
   - Get class URI from `class_uri` metadata
   - Create subject URI from `id` field or blank node
   - Add `rdf:type` triple
   - Process each field using field metadata for property URIs
   - Recursively handle nested objects

#### Loading (RDF → Pydantic):
1. Parse RDF graph
2. Find root subject matching target class type
3. For each property:
   - Match RDF predicate to field using metadata
   - Convert RDF object to appropriate Python type
   - Handle nested objects recursively
4. Construct Pydantic model instance

## Advantages over SchemaView-based approach

1. **Self-contained**: No external schema files needed
2. **Simplified deployment**: Models contain all necessary metadata
3. **Version consistency**: Schema and models are always in sync
4. **Reduced dependencies**: No SchemaView or schema loading overhead
5. **Better performance**: No schema parsing or loading delays

## File Locations

- **Dumper**: `linkml_runtime/dumpers/pydantic_rdf_dumper.py`
- **Loader**: `linkml_runtime/loaders/pydantic_rdf_loader.py`
- **Tests**: `tests/test_loaders_dumpers/test_pydantic_rdf_dumper_loader.py`
- **Example**: `examples/pydantic_rdf_example.py`

## Integration

Both classes are automatically available through the main dumpers/loaders modules:

```python
from linkml_runtime.dumpers import pydantic_rdf_dumper
from linkml_runtime.loaders import pydantic_rdf_loader

# Or import directly
from linkml_runtime.dumpers.pydantic_rdf_dumper import PydanticRDFDumper
from linkml_runtime.loaders.pydantic_rdf_loader import PydanticRDFLoader
```

## Testing

Run the comprehensive test suite:
```bash
poetry run pytest tests/test_loaders_dumpers/test_pydantic_rdf_dumper_loader.py -v
```

Run the example:
```bash
poetry run python examples/pydantic_rdf_example.py
```

## Requirements

- Pydantic models generated by LinkML with embedded metadata
- rdflib for RDF graph operations
- Standard LinkML runtime dependencies